#!/usr/bin/env python3

import os
import sys
import jeffos
import subprocess
from datetime import datetime

_aliases = {
    "move": "mv",
    "dir": "ls"
}

_background_processes = {}

# looks for special messages designed for command line
def look_for_messages(output):
    if "$PRINT_aliases" in output:
        print(_aliases)
    if "$PRINT_background_processes" in output:
        print(_background_processes)
    return output

def run_app(path, args):
    output = subprocess.check_output([path] + args.split(" "))
    output = str(output, 'utf-8')
    output = look_for_messages(output)
    print(output)
    # reload working dir
    os.chdir(jeffos.getcwd())

def run_app_in_background(path, args):
    p = subprocess.Popen([path] + args.split(" "))
    index = str(len(_background_processes))
    _background_processes[path+'['+index+']'] = p

def main():
    print("launching command line")
    print("type help for basic info")

    history = open(jeffos.OS_PATH+"usr/cmd_history.txt", "a")
    history.write("starting session "+datetime.now().strftime("%d-%m-%Y %H:%M")+"\n")

    os.chdir("Jeff-OS/")
    sys.path.pop(0)
    sys.path.insert(0, os.getcwd()+"/sys/lib/")
    global OS_PATH
    OS_PATH = os.getcwd()

    i = ""
    while True:
        i = input("cmd>")
        look_for_messages(i)

        args = i.split(" ")
        app_name = args[0]
        if app_name in _aliases.keys():
            app_name = _aliases[i]
        args = " ".join(args)

        history.write(i+"\n")

        if os.path.isfile(OS_PATH+"/sys/bin/"+app_name):
            if args[-1] == "&":
                args.replace("&", "")
                run_app_in_background(OS_PATH+"/sys/bin/"+app_name, args)
            else:
                run_app(OS_PATH+"/sys/bin/"+app_name, args)
        elif i == "exit" or i == "quit":
            break
        else:
            print(f"app '{i}' not found")

    print("closing terminal")
    history.close()

if __name__ == "__main__":
    main()