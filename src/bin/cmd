#!/usr/bin/env python3

import os
import sys
import jeffos
import subprocess
import signal
from datetime import datetime
from pynput.keyboard import Key, Listener
from jeffos.color import colored, OK

_aliases = {
    "move": "mv",
    "dir": "ls"
}

_background_processes = {}

_is_running = True

def handle_signal(signum, frame):
    global _is_running
    print(OK+"ctrl-c was pressed")
    print("press enter")
    _is_running = False

signal.signal(signal.SIGINT, handle_signal)

# FIXME: doesn't work, since we don't save output
# looks for special messages designed for command line
def look_for_messages(output):
    if "$PRINT_aliases" in output:
        print(_aliases)
    if "$PRINT_background_processes" in output:
        print(_background_processes)
    return output

def run_app(path, args):
    if args != "":
        args = args.split(" ")
    else:
        args = []
    subprocess.call([path] + args)
    # reload working dir
    os.chdir(jeffos.getcwd())

def run_app_in_background(path, args):
    p = subprocess.Popen([path] + args.split(" "))
    index = str(len(_background_processes))
    _background_processes[path+'['+index+']'] = p

def parse_input(i, history):
    if not _is_running:
        return

    history.write("starting session "+datetime.now().strftime("%d-%m-%Y %H:%M")+"\n")

    look_for_messages(i)

    args = i.split(" ")
    app_name = args[0]
    args.pop(0)
    if app_name in _aliases.keys():
        app_name = _aliases[i]
    args = " ".join(args)

    history.write(i+"\n")

    if os.path.isfile(jeffos.OS_PATH+"/sys/bin/"+app_name):
        if len(args) != 0 and args[-1] == "&":
            args.replace("&", "")
            run_app_in_background(jeffos.OS_PATH+"/sys/bin/"+app_name, args)
        else:
            run_app(jeffos.OS_PATH+"/sys/bin/"+app_name, args)
    elif i == "exit" or i == "quit":
        return False
    else:
        i = colored(i, "blue")
        print(f"app '{i}' not found")

def main():
    print(OK+"launching command line")
    print("type help for basic info")

    os.chdir("Jeff-OS/")

    history = open(jeffos.OS_PATH+"usr/cmd_history.txt", "a")

    global _is_running
    while _is_running:
        parse_input(input(colored("cmd>", "yellow")), history)

    history.close()
        
    print(OK+"closing terminal")

if __name__ == "__main__":
    main()